"use strict";var TAU=2*Math.PI,WIDTH=window.innerWidth,HEIGHT=window.innerHeight,center=new THREE.Vector3(0,0,0),particleDestination=new THREE.Vector3(0,0,200),VIEW_ANGLE=100,ASPECT=WIDTH/HEIGHT,NEAR=.01,FAR=4e3,spawnRate=50,container=document.querySelector("#container"),renderer=new THREE.WebGLRenderer({preserveDrawingBuffer:!0});renderer.autoClear=!0;var camera=new THREE.PerspectiveCamera(VIEW_ANGLE,ASPECT,NEAR,FAR),scene=new THREE.Scene;scene.add(camera),camera.position.x=0,camera.position.y=0,camera.position.z=500,camera.lookAt(new THREE.Vector3(0,0,0)),camera.rotation.z=Math.PI,renderer.setSize(WIDTH,HEIGHT),container.appendChild(renderer.domElement);var standardMaterial=new THREE.MeshLambertMaterial({color:16777215,transparent:!0,opacity:.15}),standardGeometry=new THREE.CylinderGeometry(.045*(WIDTH+HEIGHT),.045*(WIDTH+HEIGHT),.01,4);standardGeometry.applyMatrix((new THREE.Matrix4).makeRotationX(Math.PI/2));var pointLight=new THREE.PointLight(16777215);pointLight.position.x=0,pointLight.position.y=0,pointLight.position.z=500,scene.add(pointLight);var numGroups=32,groups=_.map(new Array(numGroups),function(){return[]}),groupAngle=TAU/numGroups,highlightedGroups=[];function highlightGroup(e,a){var t=groups[e];if(!t)return e;if(-1!==highlightedGroups.indexOf(t))return e;if(a){var r=_.range(numGroups);for(r.splice(e,1);unhighlightGroup(r[0]),void 0!==r.shift(););}return highlightedGroups.push(t),_.each(t,function(e){e.material.__color=e.material.color,e.material.color=new THREE.Color(16777215)}),e}function unhighlightGroup(e){var a=groups[e];if(!a)return e;var t=highlightedGroups.indexOf(a);return-1===t||(highlightedGroups.splice(t,1),_.each(a,function(e){e.material.__color&&(e.material.color=e.material.__color)})),e}var availableParticles=[],activeParticles=[];function getParticles(e,a){for(e=e||1;availableParticles.length<e;)availableParticles.push(spawnParticle());var t=availableParticles.splice(0,e);return t.forEach(function(e){setupParticle(e,a),groups[e.groupId].push(e),scene.add(e)}),activeParticles=activeParticles.concat(t),t}function setupParticle(e,a){(e=_.extend(e,a)).geometry.dynamic=!0,e.geometry.verticesNeedUpdate=!0,e.geometry.normalsNeedUpdate=!0;var t=Math.random(),r=Math.random(),i=t*WIDTH-.5*WIDTH,o=r*HEIGHT-.5*HEIGHT;e.position.x=i,e.position.y=o,e.angle=Math.atan2(o,i),e.speed=-1,e.groupId=(Math.floor(e.angle/groupAngle)+numGroups)%numGroups;var n=getRGB(colorMap,colorMapData,i+.5*WIDTH,HEIGHT-(o+.5*HEIGHT));e.material.color=new THREE.Color(n)}function recycleParticle(e){scene.remove(e);var a=activeParticles.indexOf(e);activeParticles.splice(a,1),a=groups[e.groupId].indexOf(e),groups[e.groupId].splice(a,1),availableParticles.push(e)}function spawnParticle(e){var a=_.extend(new THREE.Mesh(standardGeometry,standardMaterial.clone()),{age:0,lifespan:2e3,birthday:startTime},e);return a.endTime=a.birthday+a.lifespan,a}function updateParticle(e,a){e.age=(a-e.birthday)/e.lifespan,1<e.age?recycleParticle(e):(e.position.x+=Math.cos(e.angle)*e.speed,e.position.y+=Math.sin(e.angle)*e.speed,e.position.z=particleDestination.z*e.age,e.material.opacity=.3+e.age*e.age,e.scale.x=1-e.age,e.scale.y=1-e.age,e.scale.z=1-e.age)}var afID,startTime=Date.now(),ticksPerSecond=60,millisPerTick=1e3/ticksPerSecond,now=startTime;function play(){afID||onAnimationFrame()}function stop(){cancelAnimationFrame(afID),afID=null}function onAnimationFrame(){update(Date.now()-startTime),afID=requestAnimationFrame(onAnimationFrame),renderer.render(scene,camera)}function setup(){loadColorMap()}var colorMap,colorMapCanvas,colorMapCtx,colorMapData,tick=0,prevTick=-1,activeGroupId=-1;function update(a){prevTick!=(tick=a/millisPerTick)&&getParticles(spawnRate,{birthday:a}),activeParticles.forEach(function(e){updateParticle(e,a)});var e=TAU*(tick%1080/1080);camera.rotation.z=e,camera.position.x=Math.cos(e)*WIDTH*.025,camera.position.y=Math.sin(e)*HEIGHT*.025,camera.lookAt(center),prevTick=tick}function loadColorMap(){(colorMap=new Image).crossOrigin="anonymous",colorMap.src="http://www.theorigin.net/silkbrush/img/colormabtyhyup.png",colorMap.onload=postColorMapLoad}function postColorMapLoad(){var e=document.createElement("canvas");e.attributes.height=e.attributes.width=100,(colorMapCtx=e.getContext("2d")).drawImage(colorMap,0,0,100,100),colorMapData=colorMapCtx.getImageData(0,0,100,100),play()}function getRGB(e,a,t,r){var i=a.data,o=r/HEIGHT,n=t/WIDTH*a.width<<2,c=o*a.height>>0,l=a.width<<2;return i[n+c*l+0]<<16|i[n+c*l+1]<<8|i[n+c*l+2]}setup();